<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html  lang='zh-CN'>
	<head>
		<title>一段Old Style C代码：不带类型声明的形参</title>
		<meta charset="utf-8">
		<META NAME="Description" CONTENT="展示不带类型声明的形参的C语言代码，兼论浮点数的表示方法">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="http://xie-yu.github.com/xie-yu.xml" />
		<link rel="stylesheet" type="text/css" href="../../css/global.css" />
		<link rel="stylesheet" type="text/css" href="../../css/simple-highlight/simple-highlight.css" />
		<script type="text/javascript" src="../../js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="../../js/global.js"></script>
		<script type="text/javascript" src="../../js/simple-highlight/simple-highlight.js"></script>
		<script type="text/javascript" src="http://js.tongji.linezing.com/2940294/tongji.js"></script>
	</head>
	<body>
		<div id="main">
			<div id="header">
				<div id="logo"><img src='../../img/logo.gif'></img>ie-Yu的博客</div>
				<div id="index">
					<span><a href="../../index.html">首页</a></span>
					<span><a href="../index.html"  class="index-sel">博客</a></span>
					<span><a href="../../about.html">关于</a></span>
				</div>
				<div id="self-intro">
					<div id="avatar">
						<img src="../../img/me.gif"></img>
					</div>
					<div id="intro-text">
						我是谢彧，在这里写博客<br />
						记录下学习的收获<br />
						实践有趣的想法<br />
						你可以通过<a href='http://feeds.feedburner.com/xie-yu' target="_blank"> RSS </a>获得本博客的更新<br />
						我的邮箱是：xieofyu at gmail.com
					</div>
				</div>
				<div class="clear"></div>
			</div>
			<div id="content">
				<div class="blog-view">
					<div class="blog-title-wrap">
						<div class="blog-title">
							<h1>一段Old Style C代码：不带类型声明的形参</h1>
						</div>
						<div class="blog-title-info">
							<span class="date">2012-9-13</span>
						</div>
					</div>
					<div class="blog-content-view">
						<p>
							想想看下面一段程序的输出是什么？注意看sqr函数的形参部分，噢，它真的是合法的，只是模样有点古怪，这就是所谓的Old Style（K&R）C。
							<pre><div id='old-style-code'>
 double sqr(x) { return x * x; }
 int main()
 {
	 printf("sqr(3.0): %f\n", sqr(3.0));
	 printf("sqr(3): %f\n", sqr(3));
	 return 0;
 }</div></pre>
							在我的机器上，结果是：
							<pre><div id='code-result'>
 sqr(3.0): 0.000000
 sqr(3): 9.000000 </div></pre>
							如果没有为形参指定类型，结果是未定义的。试了几个编译器和机器，都采用将实参转为整数的方式，所以3.0变成了0。
						</p>
						<p>
							可是，3.0转换为0的时候，发生了什么呢？让我们看看（VC生成的）汇编码：
							<pre><div id='asm-code'>
 printf("sqr(3.0): %f\n", sqr(3.0));
 0040EA08   push        40080000h
 0040EA0D   push        0
 0040EA0F   call        @ILT+0(_sqr) (00401005)
 0040EA14   fstp        qword ptr [esp]
 0040EA17   push        offset string "sqr(*p++): %f\n" (00424fe0)
 0040EA1C   call        printf (00401170)
 0040EA21   add         esp,0Ch</div></pre>
							在这段代码的头2行，我们看到了两个连续的压栈操作，似乎是想传2个参数进去。sqr只需要一个参数，所以只取了后进栈的参数，即0，<!--
							-->所以上述程序结果是0.
						</p>
						<p>
							那么，这个0，还有那个40080000h是怎么来的呢？这就牵涉到double类型的数据表示方法，以及小尾端的知识了。<!--
							-->double有64位，从左往右，先是1位符号位，再是11位阶符，最后是52位尾数，其中阶要加上1023。所以3.0的浮点表示应该是<!--
							-->4008-0000-0000-0000H，再转换为小尾端的顺序，就是0000-0000-0000-0840H，将3.0转换为int时，分成<!--
							-->了2个int数据，头一个是0，后一个再转为正常顺序就是40080000H。
						</p>
						<p>
							到这里，试着将sqr的声明改为：<code>double sqr(x, y)</code>，同样传3.0进去，则x赋为0，y赋为40080000H。
						</p>
						<p>
							这段代码改自P.J Plaucer的著作<span class='book-title'>The Standard C Library</span>中第0章的习题。摘抄这本书的代码真有点<!--
							-->不放心啊，Plaucer在前言里面的版权声明好吓人……不过，刚开始看到这段代码的输出，着实吓了一跳。也许这段古董代码的最大意义<!--
							-->，就是告诫我们，不要使用未定义的编程方式吧。
						</p>
						<p>
							<div id="seecomments"><a href="#disqus_thread" onclick="seeComments(this)">点击添加评论<img src='../../img/comment.gif' /></a></div>
							<div id="disqus_thread"></div>
						</p>
						<div class="link-to">
							<div class="link-toright"><a href="./greedy-method-for-assignment-problem.html">二分图最大匹配的贪心解法及证明 »</a></div>
						</div>
						<div class="clear"></div>
					</div>
				</div>
			</div>
			<div id="push">
				
			</div>
		</div>
		<div id="footer">
			<div id="footer-note">
				Xie-Yu博客· github/xie-yu · design by 谢彧
			</div>
		</div>
	</body>
	<script type="text/javascript">
		$(document).ready(function() {
				$("#old-style-code").simpleHighlight();
				$("#code-result").simpleHighlight();
				$("#asm-code").simpleHighlight();
		});
	</script>
</html>
